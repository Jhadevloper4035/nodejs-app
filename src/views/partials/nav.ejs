<%
  // =========================
  // CATEGORIES (ONE TIME)
  // =========================
  const allCats = categories || [];

  // Parent categories: parent === null
  const parents = allCats.filter(c => !c.parent);

  // Children grouped by parentId
  const childrenByParent = {};
  allCats.forEach(c => {
    if (c.parent && c.parent._id) {
      const pid = String(c.parent._id);
      (childrenByParent[pid] ||= []).push(c);
    }
  });
%>

<style>
  /* =========================
     DESKTOP HOVER BUG FIX
     ========================= */
  .menu-item.has-submenu {
    position: relative;
  }

  /* Hide submenu by default */
  .menu-item.has-submenu .sub-menu {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 9999;

    opacity: 0;
    visibility: hidden;
    transform: translateY(8px);
    transition: all 0.2s ease;
  }

  /* Show submenu on hover */
  .menu-item.has-submenu:hover > .sub-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  /* Hover bridge to prevent flicker/gap */
  .menu-item.has-submenu::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    top: 100%;
    height: 12px; /* increase if still flickers */
  }
</style>

<!-- =========================
     HEADER
     ========================= -->
<header id="header" class="header-default header-style-4">
  <div class="main-header">
    <div class="container">
      <div class="row wrapper-header align-items-center">

        <div class="col-xl-5 d-none d-xl-block">
          <div class="wrapper-header-left d-flex align-items-center gap-20">
            <a href="/store" class="text-decoration-underline text-caption-1">Track Order</a>
            <a href="/about-us" class="text-decoration-underline text-caption-1">About Us</a>
            <a href="/contact-us" class="text-decoration-underline text-caption-1">Customer Support</a>
          </div>
        </div>

        <div class="col-md-4 col-3 d-xl-none">
          <a href="#mobileMenu" class="mobile-menu" data-bs-toggle="offcanvas" aria-controls="mobileMenu">
            <i class="icon icon-categories"></i>
          </a>
        </div>

        <div class="col-xl-2 col-md-4 col-6 text-center">
          <a href="/" class="logo-header">
            <img src="/images/logo/logo3.png" alt="logo" class="logo">
          </a>
        </div>

        <div class="col-xl-5 col-md-4 col-3">
          <ul class="nav-icon d-flex justify-content-end align-items-center">
            <li class="nav-search">
              <a href="#search" data-bs-toggle="modal" class="nav-icon-item">
                <span class="icon icon-search2"></span>
              </a>
            </li>

            <li class="nav-account">
              <a href="#" class="nav-icon-item">
                <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"
                  xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21"
                    stroke="#181818" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  <path
                    d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z"
                    stroke="#181818" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </a>

              <div class="dropdown-account dropdown-login">
                <div class="sub-top">
                  <% if (user && user.email) { %>
                    <p class="text-center mb-2">
                      Welcome, <strong><%= user.email %></strong>
                    </p>
                    <a href="/dashboard" class="tf-btn btn-reset">My Account</a>
                    <form action="/logout" method="POST" style="margin-top: 10px;">
                      <button type="submit" class="tf-btn btn-outline w-100">Logout</button>
                    </form>
                  <% } else { %>
                    <a href="/login" class="tf-btn btn-reset">Login</a>
                    <p class="text-center text-secondary-2">
                      Don't have an account? <a href="/register">Register</a>
                    </p>
                  <% } %>
                </div>
                <div class="sub-bot">
                  <span class="body-text-">Support</span>
                </div>
              </div>
            </li>

            <li class="nav-wishlist">
              <a href="/wishlist" class="nav-icon-item">
                <span class="icon icon-heart"></span>
              </a>
            </li>

            <li class="nav-cart">
              <a href="/cart" class="nav-icon-item">
                <span class="icon icon-ShoppingBagOpen"></span>
                <span class="count-box" id="nav-cart-count"><%= cartCount %></span>
              </a>
            </li>
          </ul>
        </div>

      </div>
    </div>
  </div>

  <!-- =========================
       DESKTOP NAV (EJS)
       ========================= -->
  <div class="header-bottom d-none d-xl-block header-dark">
    <div class="container">
      <div class="wrapper-header d-flex justify-content-center align-items-center">
        <nav class="box-navigation text-center">
          <ul class="box-nav-ul d-flex align-items-center justify-content-center d-none d-xl-flex">

            <% parents.forEach(parent => { 
                const kids = childrenByParent[String(parent._id)] || [];
                const hasChildren = kids.length > 0;
            %>

              <li class="menu-item <%= hasChildren ? 'has-submenu' : '' %>">
                <a href="/shop/<%= parent.slug %>" class="item-link">
                  <%= parent.name %>
                  <% if (hasChildren) { %><i class="icon icon-arrow-down"></i><% } %>
                </a>

                <% if (hasChildren) { %>
                  <div class="sub-menu submenu-default">
                    <ul class="menu-list">
                      <% kids.forEach(child => { %>
                        <li>
                          <a href="/shop/<%= parent.slug %>/<%= child.slug %>" class="menu-link-text">
                            <%= child.name %>
                          </a>
                        </li>
                      <% }) %>
                    </ul>
                  </div>
                <% } %>
              </li>

            <% }) %>

          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>
<!-- /Header -->

<!-- =========================
     MOBILE MENU (EJS)
     ========================= -->
<div class="offcanvas offcanvas-start canvas-mb" id="mobileMenu">
  <span class="icon-close icon-close-popup" data-bs-dismiss="offcanvas" aria-label="Close"></span>

  <div class="mb-canvas-content">
    <div class="mb-body">
      <div class="mb-content-top">
        <form class="form-search" action="/search" method="GET">
          <fieldset class="text">
            <input type="text" placeholder="What are you looking for?" name="q" required>
          </fieldset>
          <button type="submit">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M11 19C15.4183 19 19 15.4183 19 11C19 6.58172 15.4183 3 11 3C6.58172 3 3 6.58172 3 11C3 15.4183 6.58172 19 11 19Z"
                stroke="#181818" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M20.9984 20.9999L16.6484 16.6499" stroke="#181818" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
          </button>
        </form>

        <ul class="nav-ul-mb">

          <% parents.forEach(parent => { 
              const kids = childrenByParent[String(parent._id)] || [];
              const hasChildren = kids.length > 0;
              const collapseId = `dropdown-cat-${String(parent._id)}`;
          %>

            <li class="nav-mb-item">

              <% if (hasChildren) { %>
                <a href="#<%= collapseId %>"
                   class="collapsed mb-menu-link"
                   data-bs-toggle="collapse"
                   aria-expanded="false"
                   aria-controls="<%= collapseId %>">
                  <span><%= parent.name %></span>
                  <span class="btn-open-sub"></span>
                </a>

                <div id="<%= collapseId %>" class="collapse">
                  <ul class="sub-nav-menu">
                    <% kids.forEach(child => { %>
                      <li>
                        <a href="/shop/<%= parent.slug %>/<%= child.slug %>" class="sub-nav-link">
                          <%= child.name %>
                        </a>
                      </li>
                    <% }) %>
                  </ul>
                </div>
              <% } else { %>
                <a href="/shop/<%= parent.slug %>" class="mb-menu-link">
                  <%= parent.name %>
                </a>
              <% } %>

            </li>

          <% }) %>

        </ul>
      </div>

      <!-- (keep your other mobile content as-is below) -->
      <div class="mb-other-content">
        <!-- your existing wishlist/login/help/contact info -->
      </div>

    </div>
  </div>
</div>
<!-- /Mobile Menu -->