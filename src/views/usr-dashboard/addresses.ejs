
<div class="my-account-content">
  <div class="account-address">
    <div class="text-center widget-inner-address">
      <button class="tf-btn btn-fill radius-4 mb_20 btn-address" type="button">
        <span class="text text-caption-1">Add a new address</span>
      </button>

      <%- include("add-new-address") %>

      <div class="list-account-address">
        <% if (!addresses || addresses.length===0) { %>
          <p>No addresses saved yet.</p>
        <% } else { %>

          <% addresses.forEach(function(a){ %>
            <div class="account-address-item">
              <h6 class="mb_20">
                <%= a.isDefault ? "Default" : (a.label || "Address" ) %>
              </h6>

              <p><%= a.fullName %></p>
              <p><%= a.line1 %></p>

              <% if (a.line2) { %>
                <p><%= a.line2 %></p>
              <% } %>

              <% if (a.landmark) { %>
                <p>Landmark: <%= a.landmark %></p>
              <% } %>

              <p><%= a.city %>, <%= a.state %> - <%= a.postalCode %></p>
              <p><%= a.country || "India" %></p>

              <p class="mb_10">
                <%= a.phone %>
                <% if (a.alternatePhone) { %>
                  , <%= a.alternatePhone %>
                <% } %>
              </p>

              <div class="d-flex gap-10 justify-content-center">
                <button type="button" class="tf-btn radius-4 btn-fill btn-edit-address">
                  <span class="text">Edit</span>
                </button>

                <!-- DELETE FORM -->
                <form class="delete-address-form" data-id="<%= a._id %>">
                  <button type="submit" class="tf-btn radius-4 btn-outline">
                    <span class="text">Delete</span>
                  </button>
                </form>
              </div>

              <!-- EDIT ADDRESS FORM (PRE-FILLED) -->
              <form class="edit-form-address wd-form-address" method="PATCH"
                action="/api/user/address/<%= a._id %>" style="display:none;">
                <div class="title">Edit address</div>

                <fieldset class="mb_20">
                  <input type="text" name="fullName" value="<%= a.fullName %>" required />
                </fieldset>

                <fieldset class="mb_20">
                  <input type="text" name="phone" value="<%= a.phone %>" required />
                </fieldset>

                <fieldset class="mb_20">
                  <input type="text" name="alternatePhone" value="<%= a.alternatePhone || '' %>" />
                </fieldset>

                <fieldset class="mb_20">
                  <input type="text" name="line1" value="<%= a.line1 %>" required />
                </fieldset>

                <fieldset class="mb_20">
                  <input type="text" name="line2" value="<%= a.line2 || '' %>" />
                </fieldset>

                <fieldset class="mb_20">
                  <input type="text" name="landmark" value="<%= a.landmark || '' %>" />
                </fieldset>

                <fieldset class="mb_20">
                  <input type="text" name="city" value="<%= a.city %>" required />
                </fieldset>

                <fieldset class="mb_20">
                  <input type="text" name="state" value="<%= a.state %>" required />
                </fieldset>

                <fieldset class="mb_20">
                  <input type="text" name="postalCode" value="<%= a.postalCode %>" required />
                </fieldset>

                <fieldset class="mb_20">
                  <input type="text" value="India" readonly />
                </fieldset>

                <div class="tf-cart-checkbox mb_20">
                  <div class="tf-checkbox-wrapp">
                    <input type="checkbox" name="isDefault" value="true" <%=a.isDefault ? "checked" : "" %> />
                    <div><i class="icon-check"></i></div>
                  </div>
                  <label>Set as default address</label>
                </div>

                <div class="d-flex flex-column gap-20">
                  <button type="submit" class="tf-btn btn-fill radius-4">
                    <span class="text">Update address</span>
                  </button>

                  <span class="tf-btn btn-fill radius-4 btn-hide-edit-address">
                    <span class="text">Cancel</span>
                  </span>
                </div>
              </form>

            </div>
          <% }) %>

        <% } %>
      </div>
      
    </div>
  </div>
</div>

<script>
  // âœ… EDIT ADDRESS PATCH + VALIDATION
  document.addEventListener("DOMContentLoaded", () => {
    const editForms = document.querySelectorAll(".edit-form-address");

    editForms.forEach((form) => {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.isDefault = form.querySelector('input[name="isDefault"]')?.checked || false;

        const errors = validateAddress(data);
        if (errors.length) {
          alert(errors.join("\n"));
          return;
        }

        try {
          const res = await fetch(form.action, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const text = await res.text();
          const result = text ? JSON.parse(text) : {};

          if (!res.ok) throw new Error(result.message || "Failed to update address");

          window.location.reload();
        } catch (err) {
          console.error(err);
          alert(err.message || "Something went wrong");
        }
      });
    });

    function validateAddress(data) {
      const errors = [];
      if (!data.fullName?.trim()) errors.push("Full name is required");
      if (!data.phone?.match(/^[6-9]\d{9}$/)) errors.push("Enter a valid 10-digit phone number");
      if (data.alternatePhone && !data.alternatePhone.match(/^[6-9]\d{9}$/)) {
        errors.push("Alternate phone must be a valid 10-digit number");
      }
      if (!data.line1?.trim()) errors.push("Address line 1 is required");
      if (!data.city?.trim()) errors.push("City is required");
      if (!data.state?.trim()) errors.push("State is required");
      if (!data.postalCode?.match(/^\d{6}$/)) errors.push("Postal code must be 6 digits");
      return errors;
    }
  });
</script>

<script>
  
  document.addEventListener("DOMContentLoaded", () => {
    document.addEventListener("submit", async (e) => {
      const form = e.target.closest(".delete-address-form");
      if (!form) return;

      e.preventDefault();

      const addressId = form.dataset.id;
      const addressCard = form.closest(".account-address-item");

      const ok = confirm("Delete this address?\n\nThis action cannot be undone.");
      if (!ok) return;

      try {
        const res = await fetch(`/api/user/address/${addressId}`, {
          method: "DELETE",
          headers: { "Accept": "application/json" }
        });

        const text = await res.text();
        const result = text ? JSON.parse(text) : {};

        if (!res.ok) {
          alert(result.message || "Failed to delete address");
          return;
        }

        // remove card smoothly (optional)
        if (addressCard) {
          addressCard.style.transition = "opacity 0.2s ease, transform 0.2s ease";
          addressCard.style.opacity = "0";
          addressCard.style.transform = "scale(0.97)";
          setTimeout(() => addressCard.remove(), 200);
        } else {
          window.location.reload();
        }

      } catch (err) {
        console.error(err);
        alert("Something went wrong. Please try again.");
      }
    });
  });
</script>
