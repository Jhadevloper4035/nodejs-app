<%#
  Required locals from your GET /checkout route:
    - addresses  : Array of user's Address docs
    - cart       : Cart doc (items populated with productId)

  Add to your layout <head>:
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
%>

<style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
        --cream: #F7F4EF; --warm-white: #FDFCFA; --charcoal: #1C1C1C;
        --mid: #6B6560; --accent: #8B6F47; --accent-light: #D4B896;
        --danger: #C0392B; --success: #2E7D5E;
        --border: #E4DDD5; --card-bg: #FFFFFF;
        --shadow: 0 2px 20px rgba(28,28,28,0.06);
        --shadow-hover: 0 8px 40px rgba(28,28,28,0.12);
    }

    .checkout-layout {
        max-width: 1280px; margin: 0 auto; padding: 48px 32px;
        display: grid; grid-template-columns: 1fr 420px;
        gap: 48px; align-items: start;
    }

    .section-label {
        font-family: 'Cormorant Garamond', serif;
        font-size: 28px; font-weight: 400; color: var(--charcoal);
        letter-spacing: 0.01em; margin-bottom: 24px;
    }
    .section-sublabel {
        font-size: 11px; font-weight: 500; letter-spacing: 0.12em;
        text-transform: uppercase; color: var(--mid); margin-bottom: 16px;
    }

    .card {
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: 12px; padding: 28px; margin-bottom: 24px;
        box-shadow: var(--shadow); transition: box-shadow 0.3s ease;
        animation: fadeIn 0.5s ease both;
    }
    .card:hover { box-shadow: var(--shadow-hover); }
    .card:nth-child(2) { animation-delay: 0.1s; }
    .card:nth-child(3) { animation-delay: 0.2s; }

    /* ‚îÄ‚îÄ Addresses ‚îÄ‚îÄ */
    .address-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .address-card {
        border: 2px solid var(--border); border-radius: 10px; padding: 20px;
        cursor: pointer; position: relative; transition: all 0.25s ease;
        background: var(--warm-white);
    }
    .address-card:hover  { border-color: var(--accent-light); }
    .address-card.selected { border-color: var(--accent); background: #FBF7F3; }
    .address-card .default-badge {
        position: absolute; top: 12px; right: 12px;
        background: var(--accent); color: #fff;
        font-size: 10px; font-weight: 500; letter-spacing: 0.08em;
        text-transform: uppercase; padding: 3px 8px; border-radius: 20px;
    }
    .address-card .addr-label { font-size: 11px; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; color: var(--accent); margin-bottom: 8px; }
    .address-card .addr-name  { font-size: 15px; font-weight: 500; color: var(--charcoal); margin-bottom: 4px; }
    .address-card .addr-line  { font-size: 13px; color: var(--mid); line-height: 1.5; }
    .address-card .addr-phone { font-size: 13px; color: var(--mid); margin-top: 8px; }
    .address-radio { position: absolute; top: 16px; left: 16px; width: 18px; height: 18px; accent-color: var(--accent); cursor: pointer; }
    .address-card-inner { padding-left: 28px; }

    .same-address-row {
        display: flex; align-items: center; gap: 10px; padding: 16px 20px;
        background: #F0EBE4; border-radius: 8px; margin-bottom: 16px; cursor: pointer;
    }
    .same-address-row input[type="checkbox"] { width: 17px; height: 17px; accent-color: var(--accent); cursor: pointer; }
    .same-address-row label { font-size: 14px; color: var(--charcoal); cursor: pointer; }

    /* ‚îÄ‚îÄ Form ‚îÄ‚îÄ */
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    label.field-label { font-size: 11px; font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase; color: var(--mid); }
    textarea {
        width: 100%; padding: 12px 16px; border: 1px solid var(--border);
        border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 14px;
        color: var(--charcoal); background: var(--warm-white);
        transition: border-color 0.2s; outline: none; resize: vertical; min-height: 80px;
    }
    textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(139,111,71,0.12); }

    /* ‚îÄ‚îÄ Payment methods ‚îÄ‚îÄ */
    .payment-methods { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
    .pay-option { border: 2px solid var(--border); border-radius: 10px; overflow: hidden; transition: border-color 0.2s; }
    .pay-option.active { border-color: var(--accent); }
    .pay-option-header { display: flex; align-items: center; gap: 14px; padding: 16px 20px; cursor: pointer; background: var(--warm-white); }
    .pay-option-header input[type="radio"] { width: 17px; height: 17px; accent-color: var(--accent); cursor: pointer; flex-shrink: 0; }
    .pay-option-title { font-size: 14px; font-weight: 500; color: var(--charcoal); }
    .pay-option-icons { display: flex; gap: 8px; margin-left: auto; }
    .pay-icon { background: #F0EBE4; border-radius: 4px; padding: 4px 8px; font-size: 11px; font-weight: 600; color: var(--mid); }
    .pay-body { padding: 0 20px; max-height: 0; overflow: hidden; transition: max-height 0.4s ease, padding 0.3s ease; background: #fff; }
    .pay-body.open { max-height: 400px; padding: 20px; }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar-sticky { position: sticky; top: 88px; }
    .cart-item { display: flex; gap: 14px; align-items: flex-start; padding: 16px 0; border-bottom: 1px solid var(--border); }
    .cart-item:last-child { border-bottom: none; }
    .cart-thumb { width: 72px; height: 88px; border-radius: 8px; object-fit: cover; flex-shrink: 0; background: var(--cream); }
    .cart-info { flex: 1; }
    .cart-name  { font-size: 14px; font-weight: 500; color: var(--charcoal); margin-bottom: 4px; line-height: 1.4; }
    .cart-variant { font-size: 12px; color: var(--mid); margin-bottom: 8px; }
    .cart-qty-price { display: flex; align-items: center; justify-content: space-between; }
    .qty-badge  { background: var(--cream); border: 1px solid var(--border); border-radius: 20px; padding: 3px 12px; font-size: 13px; color: var(--mid); }
    .cart-price { font-size: 15px; font-family: 'Cormorant Garamond', serif; font-weight: 600; color: var(--charcoal); }

    .summary-lines { margin-bottom: 20px; }
    .summary-line { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; color: var(--mid); border-bottom: 1px solid var(--border); }
    .summary-line:last-child { border-bottom: none; }
    .summary-line.total { font-size: 18px; font-family: 'Cormorant Garamond', serif; font-weight: 600; color: var(--charcoal); padding-top: 16px; border-top: 2px solid var(--charcoal); border-bottom: none; }
    .summary-line .val { font-weight: 500; color: var(--charcoal); }
    .summary-line .val.green { color: var(--success); }

    .btn-place-order {
        width: 100%; padding: 16px; background: var(--charcoal); color: #fff;
        border: none; border-radius: 10px; font-family: 'DM Sans', sans-serif;
        font-size: 15px; font-weight: 500; letter-spacing: 0.04em;
        cursor: pointer; transition: all 0.3s ease;
    }
    .btn-place-order:hover:not(:disabled) { background: var(--accent); transform: translateY(-1px); box-shadow: 0 8px 24px rgba(139,111,71,0.35); }
    .btn-place-order:disabled { opacity: 0.65; cursor: not-allowed; transform: none; }

    .secure-note { display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 14px; font-size: 12px; color: var(--mid); }

    /* ‚îÄ‚îÄ Alerts ‚îÄ‚îÄ */
    .alert { padding: 12px 16px; border-radius: 8px; font-size: 14px; margin-bottom: 16px; display: flex; gap: 10px; align-items: flex-start; line-height: 1.5; }
    .alert.info  { background: #EEF4FF; color: #3B5BDB; border: 1px solid #BAC8FF; }
    .alert.error { background: #FFF0F0; color: var(--danger); border: 1px solid #FFCDD2; }

    /* ‚îÄ‚îÄ Processing overlay ‚îÄ‚îÄ */
    .payment-overlay {
        display: none; position: fixed; inset: 0;
        background: rgba(28,28,28,0.65); z-index: 9999;
        align-items: center; justify-content: center; flex-direction: column; gap: 16px;
    }
    .payment-overlay.active { display: flex; }
    .payment-overlay .spinner {
        width: 48px; height: 48px;
        border: 3px solid rgba(255,255,255,0.2); border-top-color: #fff;
        border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    .payment-overlay p { color: #fff; font-size: 15px; }

    @keyframes spin    { to { transform: rotate(360deg); } }
    @keyframes fadeIn  { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 1024px) { .checkout-layout { grid-template-columns: 1fr; gap: 32px; } .sidebar-sticky { position: static; } }
    @media (max-width: 640px)  { .checkout-layout { padding: 24px 16px; } .address-grid { grid-template-columns: 1fr; } }
</style>

<!-- Processing overlay -->
<div class="payment-overlay" id="paymentOverlay">
    <div class="spinner"></div>
    <p id="overlayMsg">Processing‚Ä¶</p>
</div>

<form id="checkoutForm">
<div class="checkout-layout">

    <!-- ‚ïê‚ïê LEFT COLUMN ‚ïê‚ïê -->
    <div class="left-col">

        <!-- Step 1: Shipping Address -->
        <div class="card">
            <p class="section-sublabel">Step 01</p>
            <h2 class="section-label">Shipping Address</h2>
            <div class="alert info">
                <svg fill="none" viewBox="0 0 24 24" width="16" height="16" style="flex-shrink:0;margin-top:1px"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/><path d="M12 8v4m0 4h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                Select a saved address or add a new one.
            </div>
            <div class="address-grid" id="shipping-address-grid">
                <% addresses.forEach(function(addr) { %>
                <div class="address-card <%= addr.isDefault ? 'selected' : '' %>"
                     onclick="selectAddress('shipping', '<%= addr._id %>', this)">
                    <input type="radio" name="shippingAddressId" value="<%= addr._id %>"
                           class="address-radio" <%= addr.isDefault ? 'checked' : '' %> required>
                    <div class="address-card-inner">
                        <% if (addr.isDefault) { %><span class="default-badge">Default</span><% } %>
                        <div class="addr-label"><%= addr.label || 'Address' %></div>
                        <div class="addr-name"><%= addr.fullName %></div>
                        <div class="addr-line">
                            <%= addr.line1 %><% if (addr.line2) { %>, <%= addr.line2 %><% } %><br>
                            <% if (addr.landmark) { %><%= addr.landmark %>, <% } %>
                            <%= addr.city %>, <%= addr.state %> ‚Äì <%= addr.postalCode %><br>
                            <%= addr.country %>
                        </div>
                        <div class="addr-phone">üìû <%= addr.phone %></div>
                    </div>
                </div>
                <% }) %>
            </div>
            <a href="/account/addresses/new?redirect=checkout"
               style="font-size:13px;color:var(--accent);text-decoration:none;display:inline-flex;align-items:center;gap:6px;margin-top:4px;">
                <svg width="16" height="16" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/><path d="M12 8v8M8 12h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                Add New Address
            </a>
        </div>

        <!-- Step 2: Billing Address -->
        <div class="card">
            <p class="section-sublabel">Step 02</p>
            <h2 class="section-label">Billing Address</h2>
            <div class="same-address-row" onclick="toggleSameBilling()">
                <input type="checkbox" id="sameBilling" name="sameBilling" value="true" checked onchange="toggleBillingSection()">
                <label for="sameBilling">Same as shipping address</label>
            </div>
            <div id="billing-address-section" style="display:none;">
                <div class="address-grid" id="billing-address-grid">
                    <% addresses.forEach(function(addr) { %>
                    <div class="address-card" onclick="selectAddress('billing', '<%= addr._id %>', this)">
                        <input type="radio" name="billingAddressId" value="<%= addr._id %>" class="address-radio">
                        <div class="address-card-inner">
                            <% if (addr.isDefault) { %><span class="default-badge">Default</span><% } %>
                            <div class="addr-label"><%= addr.label || 'Address' %></div>
                            <div class="addr-name"><%= addr.fullName %></div>
                            <div class="addr-line">
                                <%= addr.line1 %><% if (addr.line2) { %>, <%= addr.line2 %><% } %><br>
                                <% if (addr.landmark) { %><%= addr.landmark %>, <% } %>
                                <%= addr.city %>, <%= addr.state %> ‚Äì <%= addr.postalCode %><br>
                                <%= addr.country %>
                            </div>
                            <div class="addr-phone">üìû <%= addr.phone %></div>
                        </div>
                    </div>
                    <% }) %>
                </div>
            </div>
        </div>

        <!-- Step 3: Order Note -->
        <div class="card">
            <p class="section-sublabel">Step 03 (Optional)</p>
            <h2 class="section-label" style="font-size:22px;">Order Note</h2>
            <div class="form-group">
                <label class="field-label" for="orderNote">Special instructions</label>
                <textarea id="orderNote" name="orderNote" placeholder="e.g. Please leave at the door, gift wrap, etc."></textarea>
            </div>
        </div>

        <!-- Step 4: Payment Method -->
        <div class="card">
            <p class="section-sublabel">Step 04</p>
            <h2 class="section-label">Payment Method</h2>

            <!-- Error displayed here when payment fails ‚Äî user stays on this page -->
            <div id="paymentError" class="alert error" style="display:none;">
                <svg fill="none" viewBox="0 0 24 24" width="16" height="16" style="flex-shrink:0;margin-top:1px"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/><path d="M12 8v4m0 4h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                <span id="paymentErrorMsg">Payment failed. Please try again.</span>
            </div>

            <div class="payment-methods">

                <!-- Card -->
                <div class="pay-option active" id="pay-card">
                    <div class="pay-option-header" onclick="selectPayment('card')">
                        <input type="radio" name="paymentMethod" value="card" id="pm-card" checked>
                        <label for="pm-card" class="pay-option-title">Credit / Debit Card</label>
                        <div class="pay-option-icons">
                            <span class="pay-icon">VISA</span>
                            <span class="pay-icon">MC</span>
                            <span class="pay-icon">AMEX</span>
                        </div>
                    </div>
                    <div class="pay-body open" id="body-card">
                        <p style="font-size:13px;color:var(--mid);line-height:1.6;">
                            You'll be securely redirected to Razorpay to complete your card payment.
                        </p>
                    </div>
                </div>

                <!-- UPI -->
                <div class="pay-option" id="pay-upi">
                    <div class="pay-option-header" onclick="selectPayment('upi')">
                        <input type="radio" name="paymentMethod" value="upi" id="pm-upi">
                        <label for="pm-upi" class="pay-option-title">UPI</label>
                        <div class="pay-option-icons">
                            <span class="pay-icon">GPay</span>
                            <span class="pay-icon">PhPe</span>
                            <span class="pay-icon">BHIM</span>
                        </div>
                    </div>
                    <div class="pay-body" id="body-upi">
                        <p style="font-size:13px;color:var(--mid);line-height:1.6;">
                            Enter your UPI ID or scan a QR code via Razorpay.
                        </p>
                    </div>
                </div>

                <!-- COD -->
                <div class="pay-option" id="pay-cod">
                    <div class="pay-option-header" onclick="selectPayment('cod')">
                        <input type="radio" name="paymentMethod" value="cod" id="pm-cod">
                        <label for="pm-cod" class="pay-option-title">Cash on Delivery</label>
                        <div class="pay-option-icons">
                            <span class="pay-icon">COD</span>
                        </div>
                    </div>
                    <div class="pay-body" id="body-cod">
                        <%
                            var codTotal   = 0;
                            cart.items.forEach(function(it) { codTotal += (Number(it.price)||0) * (Number(it.quantity)||0); });
                            var codAdvance = Math.round((codTotal / 3) * 100) / 100;
                            var codRemain  = Math.round((codTotal - codAdvance) * 100) / 100;
                        %>
                        <div style="background:#FFF9DB;border:1px solid #FFD43B;border-radius:8px;padding:14px 16px;">
                            <div style="font-size:12px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:#E67700;margin-bottom:10px;">‚ö†Ô∏è Advance Payment Required</div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                <div style="background:#fff;border-radius:6px;padding:10px 14px;border:1px solid #FFD43B;">
                                    <div style="font-size:11px;color:#aaa;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px;">Pay Now (1/3)</div>
                                    <div style="font-size:18px;font-weight:600;color:#E67700;">‚Çπ<%= codAdvance.toLocaleString('en-IN') %></div>
                                    <div style="font-size:11px;color:#888;margin-top:2px;">via Razorpay</div>
                                </div>
                                <div style="background:#fff;border-radius:6px;padding:10px 14px;border:1px solid #FFD43B;">
                                    <div style="font-size:11px;color:#aaa;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px;">Pay on Delivery (2/3)</div>
                                    <div style="font-size:18px;font-weight:600;color:var(--charcoal);">‚Çπ<%= codRemain.toLocaleString('en-IN') %></div>
                                    <div style="font-size:11px;color:#888;margin-top:2px;">cash at doorstep</div>
                                </div>
                            </div>
                            <p style="font-size:12px;color:#888;margin-top:10px;line-height:1.5;">
                                ‚Çπ<%= codAdvance.toLocaleString('en-IN') %> must be paid now as advance.
                                Remaining ‚Çπ<%= codRemain.toLocaleString('en-IN') %> collected at doorstep.
                            </p>
                        </div>
                    </div>
                </div>

            </div>

            <input type="hidden" name="cartId" value="<%= cart._id %>">
        </div>

    </div><!-- /left-col -->

    <!-- ‚ïê‚ïê RIGHT SIDEBAR ‚ïê‚ïê -->
    <div class="sidebar-sticky">
        <div class="card" style="padding:24px;">
            <h2 class="section-label" style="font-size:22px;margin-bottom:20px;">Order Summary</h2>

            <% cart.items.forEach(function(item) { %>
            <div class="cart-item">
                <img src="<%= item.image %>" alt="<%= item.name %>" class="cart-thumb">
                <div class="cart-info">
                    <div class="cart-name"><%= item.name %></div>
                    <div class="cart-variant">Qty: <%= item.quantity %></div>
                    <div class="cart-qty-price">
                        <span class="qty-badge">√ó <%= item.quantity %></span>
                        <span class="cart-price">‚Çπ<%= (Number(item.price) * Number(item.quantity)).toLocaleString('en-IN') %></span>
                    </div>
                </div>
            </div>
            <% }) %>

            <%
                var summaryTotal   = 0;
                cart.items.forEach(function(it) { summaryTotal += (Number(it.price)||0) * (Number(it.quantity)||0); });
                var summaryAdvance = Math.round((summaryTotal / 3) * 100) / 100;
                var summaryRemain  = Math.round((summaryTotal - summaryAdvance) * 100) / 100;
            %>
            <div class="summary-lines" style="margin-top:16px;">
                <div class="summary-line">
                    <span>Subtotal (<%= cart.items.length %> items)</span>
                    <span class="val">‚Çπ<%= summaryTotal.toLocaleString('en-IN') %></span>
                </div>
                <div class="summary-line">
                    <span>Shipping</span>
                    <span class="val green">Free</span>
                </div>
                <div class="summary-line total">
                    <span>Total</span>
                    <span>‚Çπ<%= summaryTotal.toLocaleString('en-IN') %></span>
                </div>
                <!-- COD breakdown ‚Äî shown/hidden by JS -->
                <div id="cod-advance-summary" style="display:none;margin-top:12px;padding:12px;background:#FFF9DB;border-radius:8px;border:1px solid #FFD43B;">
                    <div style="display:flex;justify-content:space-between;font-size:13px;padding:4px 0;color:var(--mid);">
                        <span>Pay Now (advance 1/3)</span>
                        <strong style="color:#E67700;">‚Çπ<%= summaryAdvance.toLocaleString('en-IN') %></strong>
                    </div>
                    <div style="display:flex;justify-content:space-between;font-size:13px;padding:4px 0;color:var(--mid);">
                        <span>Pay on Delivery (2/3)</span>
                        <strong>‚Çπ<%= summaryRemain.toLocaleString('en-IN') %></strong>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-place-order" id="placeOrderBtn">Place Order ‚Üí</button>
            <div class="secure-note">
                <svg fill="none" viewBox="0 0 24 24" width="14" height="14"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Secure 256-bit SSL encrypted checkout
            </div>
        </div>
    </div>

</div>
</form>

<script>
// ‚îÄ‚îÄ Address selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectAddress(type, id, el) {
    document.getElementById(type + '-address-grid')
        .querySelectorAll('.address-card').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    el.querySelector('input[type="radio"]').checked = true;
}

// ‚îÄ‚îÄ Billing address toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleSameBilling() { setTimeout(toggleBillingSection, 0); }
function toggleBillingSection() {
    const cb     = document.getElementById('sameBilling');
    const sec    = document.getElementById('billing-address-section');
    const radios = sec.querySelectorAll('input[type="radio"]');
    if (cb.checked) {
        sec.style.display = 'none';
        radios.forEach(r => r.removeAttribute('required'));
    } else {
        sec.style.display = 'block';
        radios.forEach(r => r.setAttribute('required', ''));
        const first = sec.querySelector('.address-card');
        if (first && !sec.querySelector('.address-card.selected')) {
            first.classList.add('selected');
            first.querySelector('input[type="radio"]').checked = true;
        }
    }
}
toggleBillingSection();

// ‚îÄ‚îÄ Payment method toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectPayment(method) {
    ['card', 'upi', 'cod'].forEach(m => {
        document.getElementById('pay-' + m).classList.toggle('active', m === method);
        document.getElementById('body-' + m).classList.toggle('open', m === method);
        document.getElementById('pm-' + m).checked = (m === method);
    });
    const cod = document.getElementById('cod-advance-summary');
    const btn = document.getElementById('placeOrderBtn');
    if (method === 'cod') {
        cod.style.display = 'block';
        btn.textContent = 'Pay ' + cod.querySelector('strong').textContent + ' Advance & Place Order ‚Üí';
    } else {
        cod.style.display = 'none';
        btn.textContent = 'Place Order ‚Üí';
    }
}

// ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showOverlay(msg) {
    document.getElementById('overlayMsg').textContent = msg || 'Processing‚Ä¶';
    document.getElementById('paymentOverlay').classList.add('active');
}
function hideOverlay() {
    document.getElementById('paymentOverlay').classList.remove('active');
}
function showError(msg) {
    const box = document.getElementById('paymentError');
    document.getElementById('paymentErrorMsg').textContent = msg;
    box.style.display = 'flex';
    box.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
function resetBtn(method, initData) {
    const btn = document.getElementById('placeOrderBtn');
    btn.disabled = false;
    btn.textContent = (method === 'cod' && initData?.codAdvanceAmount)
        ? 'Pay ‚Çπ' + initData.codAdvanceAmount.toLocaleString('en-IN') + ' Advance & Place Order ‚Üí'
        : 'Place Order ‚Üí';
}

// ‚îÄ‚îÄ POST JSON helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function postJSON(url, data) {
    const res = await fetch(url, {
        method:      'POST',
        headers:     { 'Content-Type': 'application/json' },
        body:        JSON.stringify(data),
        credentials: 'same-origin',
    });
    return res.json();
}

// ‚îÄ‚îÄ Form submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    document.getElementById('paymentError').style.display = 'none';

    const shippingAddressId = document.querySelector('input[name="shippingAddressId"]:checked')?.value;
    if (!shippingAddressId) { showError('Please select a shipping address.'); return; }

    const sameBilling = document.getElementById('sameBilling').checked;
    if (!sameBilling && !document.querySelector('input[name="billingAddressId"]:checked')) {
        showError('Please select a billing address.'); return;
    }

    const billingAddressId = sameBilling
        ? shippingAddressId
        : document.querySelector('input[name="billingAddressId"]:checked')?.value;

    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
    const orderNote     = document.getElementById('orderNote')?.value || '';
    const cartId        = document.querySelector('input[name="cartId"]')?.value;

    const btn = document.getElementById('placeOrderBtn');
    btn.disabled = true;
    btn.textContent = 'Please wait‚Ä¶';

    // ‚îÄ‚îÄ Step 1: Create Razorpay order on the server ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    showOverlay(paymentMethod === 'cod' ? 'Setting up advance payment‚Ä¶' : 'Initiating payment‚Ä¶');

    let initData;
    try {
        initData = await postJSON('/checkout/place-order', {
            shippingAddressId,
            billingAddressId,
            sameBilling,
            paymentMethod,
            orderNote,
            cartId,
        });
    } catch {
        hideOverlay();
        resetBtn(paymentMethod, null);
        showError('Network error. Please check your connection and try again.');
        return;
    }

    if (!initData.success) {
        hideOverlay();
        resetBtn(paymentMethod, null);
        showError(initData.error || 'Could not initiate payment. Please try again.');
        return;
    }

    hideOverlay();

    // ‚îÄ‚îÄ Step 2: Open Razorpay modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const rzp = new Razorpay({
        key:         initData.keyId,
        amount:      initData.amount,
        currency:    initData.currency,
        order_id:    initData.razorpayOrderId,
        name:        'Your Store Name',   // ‚Üê change this
        description: initData.isCodAdvance
            ? `Advance (1/3) ‚Äî ‚Çπ${initData.codAdvanceAmount.toLocaleString('en-IN')} of ‚Çπ${initData.totalAmount.toLocaleString('en-IN')}`
            : 'Order Payment',
        prefill: initData.prefill,
        theme:   { color: '#8B6F47' },

        // ‚îÄ‚îÄ Payment SUCCESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        handler: async function(response) {
            showOverlay('Verifying payment‚Ä¶');
            try {
                const result = await postJSON('/checkout/verify-payment', {
                    razorpay_order_id:   response.razorpay_order_id,
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_signature:  response.razorpay_signature,
                });

                if (result.success) {
                    // ‚úÖ Go to order confirmation
                    showOverlay(initData.isCodAdvance ? 'Advance paid! Redirecting‚Ä¶' : 'Payment confirmed! Redirecting‚Ä¶');
                    window.location.href = '/orders/' + result.orderId;
                } else {
                    // ‚ùå Verification failed ‚Äî stay on /checkout
                    hideOverlay();
                    resetBtn(paymentMethod, initData);
                    showError(result.error || 'Payment could not be verified. Please try again.');
                }
            } catch {
                hideOverlay();
                resetBtn(paymentMethod, initData);
                showError('Verification error. Please contact support. Payment ID: ' + response.razorpay_payment_id);
            }
        },

        // ‚îÄ‚îÄ User CLOSES modal without paying ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        modal: {
            ondismiss: async function() {
                await postJSON('/checkout/payment-failed', {}).catch(() => {});
                hideOverlay();
                resetBtn(paymentMethod, initData);
                // Stay on /checkout ‚Äî no redirect, button re-enabled
            }
        },
    });

    // ‚îÄ‚îÄ Payment DECLINED (wrong OTP, insufficient funds, etc.) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    rzp.on('payment.failed', async function(response) {
        hideOverlay();
        await postJSON('/checkout/payment-failed', {}).catch(() => {});
        resetBtn(paymentMethod, initData);
        // Stay on /checkout ‚Äî show reason so user can try a different method
        showError(response.error?.description || 'Payment failed. Please try a different payment method.');
    });

    rzp.open();
});
</script>
